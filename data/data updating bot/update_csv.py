import time
import os
import shutil
import csv
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options

data_name = "us-counties.csv"
nyc_name = "by-boro.csv"
#where chromedriver is:
CHROMEDRIVER_PATH = "/Applications/chromedriver"
#where you want to save the new data locally:
STORED_DATA_PATH = '/Users/diep/Downloads/covid_community_vulnerability-master/data' #write full path,
#don't use go back "..""

def update_covid_data():
	#change current path
	os.chdir(STORED_DATA_PATH)
	#create a webdriver that would download automatically to a local directory
	options = webdriver.ChromeOptions()
	prefs = {'download.default_directory': STORED_DATA_PATH} 
	options.add_experimental_option('prefs', prefs)
	driver = webdriver.Chrome(options=options, executable_path=CHROMEDRIVER_PATH)
	#access github NYT data
	driver.get('https://github.com/nytimes/covid-19-data')
	driver.find_element_by_link_text('U.S. County-Level Data').click()
	driver.find_element_by_link_text('Download').send_keys(Keys.ALT, Keys.ENTER)
	time.sleep(2)
	driver.quit()
	#replace the current file with the new file on MacOS
	change_csv_name(data_name)


def update_nyc_data():
	options = webdriver.ChromeOptions()
	prefs = {'download.default_directory': STORED_DATA_PATH}
	options.add_experimental_option('prefs', prefs)
	driver = webdriver.Chrome(options=options, executable_path=CHROMEDRIVER_PATH)
	#data for New York counties
	driver.get('https://github.com/nychealth/coronavirus-data/blob/master/by-boro.csv')
	driver.find_element_by_link_text('Raw').click()
	new_data = driver.find_element_by_xpath('/html/body').text
	driver.quit()
	#write a new file with the NY data
	write_csv_file(new_data, nyc_name)


def change_csv_name(data):
	#find the most recently added data
 	filename = max([STORED_DATA_PATH + "/" + f for f in os.listdir(STORED_DATA_PATH)], key=os.path.getctime)
 	#rename the recently added data (change it to csv)
 	shutil.move(filename,os.path.join(STORED_DATA_PATH, data))

def write_csv_file(new_data, filename):
	#write a new csv file with the nyc data
	outF = open(filename, "w")
	outF.writelines(new_data)
	outF.close()

#run:
update_covid_data()
update_nyc_data()
